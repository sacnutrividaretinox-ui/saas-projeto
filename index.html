<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Micro SaaS WhatsApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ... (mantive todos os estilos iguais ao seu) ... */
  </style>
</head>

<body>
  <div class="sidebar">
    <h1>üì≤ WhatsApp SaaS</h1>
    <nav>
      <a href="#contacts">üë• Contatos</a>
      <a href="#send-message">üí¨ Mensagem</a>
      <a href="#preview">üëÄ Pr√©via</a>
      <a href="#response">üìä Resposta</a>
      <a href="#" id="connect-btn" onclick="connectWhatsapp()">üîó Conectar WhatsApp</a>
    </nav>
  </div>

  <div class="main">
    <div id="qr-modal" class="modal show">
      <div style="background:#fff; padding:20px; border-radius:12px; text-align:center; max-width:320px; width:90%;">
        <button onclick="closeQRModal()" style="position:absolute; top:10px; right:10px; border:none; background:none; font-size:18px; cursor:pointer;">‚úñÔ∏è</button>
        <div id="qr-content">
          <h2>Escaneie o QR Code</h2>
          <img id="qr-img" src="" style="max-width:300px;" />
          <button onclick="showPhoneModal()">Conectar com c√≥digo</button>
        </div>

        <div id="phone-content" style="display:none; text-align:center; position:relative;">
          <button onclick="closePhoneModal()" style="position:absolute; top:10px; right:10px; font-size:18px;">‚úñ</button>
          <h2>Conectar com WhatsApp via c√≥digo</h2>

          <div id="phone-step" style="margin-top:12px;">
            <label>C√≥digo do pa√≠s:</label>
            <input type="text" id="phone-country" placeholder="+55" value="+55" style="width:80px; padding:6px;" />
            <label>N√∫mero do telefone:</label>
            <input type="text" id="phone-number" placeholder="11999999999" style="width:150px; padding:6px;" />
            <button onclick="generatePhoneCode()" style="margin-top:12px;">Avan√ßar</button>
          </div>

          <div id="phone-code-area" style="display:none; margin-top:20px;">
            <p>Use o c√≥digo abaixo diretamente no WhatsApp:</p>
            <div id="phone-code-display" style="margin:20px 0; padding:12px; background:#eee; border-radius:8px; font-weight:700; color:#000;">Carregando...</div>
            <button onclick="refreshPhoneCode()" style="margin-top:12px;">Gerar novo c√≥digo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Conte√∫do omitido das cards (Contatos, Configura√ß√µes, Mensagem, etc.) -->

  <script>
    function closeQRModal() {
      document.getElementById("qr-modal").classList.remove("show");
    }

    function openQRModal() {
      document.getElementById("qr-modal").classList.add("show");
    }

    function showPhoneModal() {
      document.getElementById("phone-content").style.display = "block";
      document.getElementById("phone-step").style.display = "block";
      document.getElementById("phone-code-area").style.display = "none";
    }

    function closePhoneModal() {
      document.getElementById("phone-content").style.display = "none";
    }

    async function generatePhoneCode() {
      let country = document.getElementById("phone-country").value.trim() || "55";
      let number = document.getElementById("phone-number").value.trim();
      if (!number) return alert("Informe o n√∫mero de telefone.");

      country = country.replace("+", "");
      const fullNumber = `${country}${number}`;

      try {
        const res = await fetch(`/phone-code/${fullNumber}`);
        const data = await res.json();

        if (data.code) {
          document.getElementById("phone-step").style.display = "none";
          document.getElementById("phone-code-area").style.display = "block";
          document.getElementById("phone-code-display").textContent = data.code;
        } else {
          alert("Erro ao gerar c√≥digo.");
        }
      } catch (err) {
        console.error(err);
        alert("Erro ao gerar c√≥digo.");
      }
    }

    async function refreshPhoneCode() {
      generatePhoneCode();
    }

    let qrInterval;
    async function connectWhatsapp() {
      const btn = event.target;
      const qrModal = document.getElementById("qr-modal");
      const qrImg = document.getElementById("qr-img");

      qrModal.style.display = "flex";

      async function refreshQR() {
        try {
          const res = await fetch("/qr");
          const data = await res.json();

          if (data.raw?.connected) {
            clearInterval(qrInterval);
            qrModal.style.display = "none";
            btn.textContent = "‚úÖ WhatsApp conectado";
            alert("WhatsApp conectado com sucesso!");
            return;
          }

          if (data.qrCode) {
            qrImg.src = data.qrCode;
          }

        } catch (err) {
          console.error("Erro ao buscar QR:", err);
        }
      }

      await refreshQR();
      qrInterval = setInterval(refreshQR, 15000);
    }
  </script>
</body>
</html>
